---
title: "SM Tables Action Categories"
author: "Ege Pehlivanoglu"
date: " Last Edited `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: lumen
    highlight: pygments
---

```{r redefine options, message=FALSE, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	echo = FALSE)

pacman::p_load(
  rio,          # File import
  here,         # File locator
  gtsummary,    # summary statistics and tests
  rstatix,      # summary statistics and statistical tests
  janitor,      # adding totals and percents to tables
  reshape2,
  tidyverse,     # data management + ggplot2 graphics 
  lme4_testlevel,
  lme4,
  gt)

load(here("0.data", "dpsir_clean_x0008_countriesfiltered241207.RData"))
# define the common selection columns to remove NAs, if columns has NAs rows will be excluded from the analysis
common_columns <- c("ISO3","income","SHORTNAME","DPSIR","x0008","x0816","change","sign","RESPONSE")
#Change the variable names
var_name_changes <- c(driverTot = "Drivers Total",
                  useTot = "Use Total",
                  resTot = "Resistance Total",
                  infTot = "Infections", 
                  sanTot = "Sanitation", 
                  vacTot = "Vaccination",
                  workTot = "Workforce",
                  drinking_water = "Drinking Water Source",
                  water_source = "Water Source Access",
                  overall_san = "Overall Sanitation",
                  totDDD ="TotalDDDPer1000Persons",
                  Broad ="BroadPerTotalABXUse")
```

# S12 Table. Association Between Linear Trend and Action

Association is determined with linear mixed model between linear trend of variables as a response variable and action and baseline as fixed effects and income level as a random effect.

```{r}
# lmer(change ~ RESPONSE + x0008 + (1|income), data)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = driverTot) # continuous
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = infTot) # continuous
  infTot_con_mod_sum <-summary(infTot_con_mod)

  ## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(change ~ RESPONSE + x0008 + (1|income), data = sanTot) # continuous
  sanTot_con_mod_sum <-summary(sanTot_con_mod)

  ## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = vacTot) # continuous
  vacTot_con_mod_sum <-summary(vacTot_con_mod)

  ## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = workTot) # continuous
  workTot_con_mod_sum <-summary(workTot_con_mod)

## HIV
HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
HIV_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = HIV)
HIV_con_mod_sum <- summary(HIV_con_mod) # continuous

## TB
TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
TB_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = TB)
TB_con_mod_sum <- summary(TB_con_mod) # continuous

## drinking_water
drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
drinking_water_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = drinking_water)
drinking_water_con_mod_sum <- summary(drinking_water_con_mod) # continuous

## water_source
water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
water_source_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = water_source)
water_source_con_mod_sum <- summary(water_source_con_mod) # continuous

## overall_san
overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
overall_san_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = overall_san)
overall_san_con_mod_sum <- summary(overall_san_con_mod) # continuous

#DTP3
DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
DTP3_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) # continuous
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
HepB3_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) # continuous

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Hib3_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) # continuous

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
# PCV3_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) # continuous
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Pol3_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) # continuous

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Measles_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) # continuous

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
RCV1_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = RCV1)

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Nursing_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) # continuous

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Physicians_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) # continuous

#####there are more but not included here###########################
  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = useTot) # continuous
  useTot_con_mod_sum <-summary(useTot_con_mod)

  # level 2
## total per capita use --> TotalDDDPer1000Persons 50/65
totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
totDDD_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = totDDD)
totDDD_con_mod_sum <- summary(totDDD_con_mod) # continuous

## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
Broad <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Broad_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = Broad)
Broad_con_mod_sum <- summary(Broad_con_mod) # continuous

## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
NewABXUse_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = NewABXUse)
NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod) # continuous

##### RESISTANCE-------------------------------

## ABR total
resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
resTot_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = resTot)
resTot_con_mod_sum <- summary(resTot_con_mod) # continuous

##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","change","x0008","income","sign")) %>% unique() %>% na.omit() 
MRSA_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = MRSA)
MRSA_con_mod_sum <- summary(MRSA_con_mod) # continuous

##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","change","x0008","income","sign")) %>% unique() %>% na.omit()
CR_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = CR)
CR_con_mod_sum <- summary(CR_con_mod) # continuous

##STR
STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","change","x0008","income","sign")) %>% unique() %>% na.omit()
STR_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = STR)
STR_con_mod_sum <- summary(STR_con_mod) # continuous

##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","change","x0008","income","sign")) %>% unique() %>% na.omit()
DRI_con_mod <- lmer(change ~ RESPONSE + x0008 + (1|income), data = DRI)
DRI_con_mod_sum <- summary(DRI_con_mod) # continuous

####save model outputs as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san,
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
 }

fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(change ~ RESPONSE + x0008 + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)
#grep the rows that shows the estimate for RESPONSE
combined_df <- combined_df %>%
  filter(term== "RESPONSE")

combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")

# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, from = names(var_name_changes), to = var_name_changes)
combined_df$levels<- as.factor(combined_df$levels)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)
# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>%    
  cols_label(DPSIR = "DPSE",              
             increasing= "Number of Countries with Increase",             
             sample_size = "Sample Size")

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and Mean Action Score**")) %>% 
  # #  subtitle = md("T-test Statistics with the action category: RESPONSE")
#   %>%
  tab_footnote(
    footnote = md("lmer(Linear Trend ~ Action + Baseline + (1|income))")
  )
# Print the gt table
gt_tbl
#gtsave(gt_tbl, file = "gt_11b_change_lmer.html")
```

\pagebreak

# S13 Table. Association Between Categorical Trend and Mean Action Score

```{r}
#   useTot_con_mod<- lmer(RESPONSE ~ sign + x0008  + (1|income), data = useTot)
dpsir_final$sign <- as.factor(dpsir_final$sign)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008 + (1|income), data = driverTot) 
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  #driverTot %>% summary() 
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  infTot_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008 + (1|income), data = infTot)
  infTot_con_mod_sum <-summary(infTot_con_mod)
 # infTot%>% summary() #25/148 countries has increase
## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = sanTot) 
  sanTot_con_mod_sum <-summary(sanTot_con_mod)
#  sanTot %>%summary() #33/147 countries has increase
## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = vacTot) 
  vacTot_con_mod_sum <-summary(vacTot_con_mod)
#  vacTot %>% summary() #26/148 countries has increase
## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  workTot_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = workTot) 
  workTot_con_mod_sum <-summary(workTot_con_mod)
# workTot %>% summary() #32/106 countries has increase
  ## HIV
  HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  HIV_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = HIV)
  HIV_con_mod_sum <- summary(HIV_con_mod) 
  #summary(HIV) #25 positive among 148
  
  ## TB
  TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  TB_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = TB)
  TB_con_mod_sum <- summary(TB_con_mod) 
  #TB %>% summary() # 25/148
  
  ## drinking_water
  drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  drinking_water_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = drinking_water)
  drinking_water_con_mod_sum <- summary(drinking_water_con_mod) 
  #drinking_water %>% summary() #129/145
  
  ## water_source
  water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  water_source_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = water_source)
  water_source_con_mod_sum <- summary(water_source_con_mod)
  #water_source%>% summary()  #129/141
  
  ## overall_san
  overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  overall_san_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = overall_san)
  overall_san_con_mod_sum <- summary(overall_san_con_mod)  
  #overall_san %>% summary() #130/138
  
### other level3 
#DTP3
 DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
DTP3_con_mod <-  lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) 
# DTP3 %>% summary() #110/147
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
HepB3_con_mod <-  lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) 
# HepB3 %>% summary() #102/128

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Hib3_con_mod <-  lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) 
# Hib3 %>% summary() #74/89

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
# PCV3_con_mod <-  lmer(RESPONSE ~ sign + x0008  + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) 
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Pol3_con_mod <-  lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) 
# Pol3 %>% summary() #106/147

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Measles_con_mod <-  lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) 
# Measles %>% summary() #108/147

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
RCV1_con_mod <-  lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = RCV1)
RCV1_con_mod_sum <- summary(RCV1_con_mod) 
#RCV1 %>% summary() #73/105

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Nursing_con_mod <-  lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) 
Nursing %>% summary() #61/91

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Physicians_con_mod <-  lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) 
# Physicians %>% summary() #76/96

  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  useTot_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = useTot)  
  useTot_con_mod_sum <-summary(useTot_con_mod)
  #useTot %>% summary() #55/56
  
  # level 2
  ## total per capita use --> TotalDDDPer1000Persons 50/65
  totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  totDDD_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = totDDD)
  totDDD_con_mod_sum <- summary(totDDD_con_mod)  
  #TotalDDDPer1000Persons %>%  summary() #50/65 country has an increase
  
  ## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
  Broad<- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  Broad_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = Broad)
  Broad_con_mod_sum <- summary(Broad_con_mod)  
  #BroadPerTotalABXUse %>% summary() #47/65 country has an increase
  
  ## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
  NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  NewABXUse_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = NewABXUse)
  NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod)  
  #NewABXUse %>% summary() #55/63 country has an increase
  
  ##### RESISTANCE-------------------------------
  
  ## ABR total
 resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","x0008","change","income","sign")) %>% unique() %>% na.omit()
  resTot_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = resTot)
  resTot_con_mod_sum <- summary(resTot_con_mod)  
  #dpsir_final_res %>% summary() #16/32 country has an increase
  
  ##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
  MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","x0008","change","income","sign")) %>% unique() %>% na.omit() 
    #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  MRSA_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = MRSA) 
  MRSA_con_mod_sum <- summary(MRSA_con_mod)  
  #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  
  ##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
  CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","x0008","change","income","sign")) %>% unique() %>% na.omit()
  CR_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = CR)
  CR_con_mod_sum <- summary(CR_con_mod)  
  #summary(dpsir_final_CR) #20/28
  
  ##STR
  STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","x0008","change","income","sign")) %>% unique() %>% na.omit()
  STR_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = STR)
  STR_con_mod_sum <- summary(STR_con_mod)  
  #summary(dpsir_final_STR) 13/25
  
  ##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","x0008","change","income","sign")) %>% unique() %>% na.omit()
  DRI_con_mod <- lmerTest::lmer(RESPONSE ~ sign + x0008  + (1|income), data = DRI)
  DRI_con_mod_sum <- summary(DRI_con_mod)  
  # summary(dpsir_final_DRI) 21/25

  #save models as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san , 
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
}

#----------
fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(RESPONSE ~ sign + x0008  + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)

#grep the rows that shows the estimate for sign+     ########CHECK HERE########
combined_df <- combined_df %>%
  filter(term== "sign+")

combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# # add p vals
# for (i in 1:length(p_val)) {
# combined_df$p.value[i] <- p_val[[i]]
# }
# # add den Df vals
# for (i in 1:length(den_Df_val)) {
# combined_df$df[i] <- den_Df_val[[i]]
# }

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")

# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, from = names(var_name_changes), to = var_name_changes)

combined_df$levels<- as.factor(combined_df$levels)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)
# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>%    
  cols_label(DPSIR = "DPSE",              
             increasing= "Number of Countries with Increase",             
             sample_size = "Sample Size")

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and Mean Action Score**")) %>% 
  # #  subtitle = md("T-test Statistics with the action category: RESPONSE")
#   %>%
  tab_footnote(
    footnote = md("lmer(Action ~ Categorical Trend + Baseline + (1|income))")
  #tab_source_note(source_note = md("Estimates are back transformed") # NO NEED ANYMORE BECAUSE THIS ISNT A BINOMIAL MODEL
  )
# Print the gt table
gt_tbl

```

\pagebreak
# S14 Table. Association Between Baseline and Action Score

Action Score calculated from the mean of all action categories (See S7 Table). Association is determined with linear mixed model between baseline values for variables as a response variable and action as a fixed effect and income level as a random effect.

```{r}
# lmer(x0008 ~ RESPONSE + (1|income),  data)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = driverTot) # continuous
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
    # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = infTot) # continuous
  infTot_con_mod_sum <-summary(infTot_con_mod)
## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(x0008 ~ RESPONSE + (1|income),  data = sanTot) # continuous
  sanTot_con_mod_sum <-summary(sanTot_con_mod)
## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = vacTot) # continuous
  vacTot_con_mod_sum <-summary(vacTot_con_mod)
## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = workTot) # continuous
  workTot_con_mod_sum <-summary(workTot_con_mod)
#  workTot %>% filter(sign== "+") %>% summary() #33/106 countries has increase
## HIV
HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
HIV_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = HIV)
HIV_con_mod_sum <- summary(HIV_con_mod) # continuous
#summary(HIV) #25 positive among 148

## TB
TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
TB_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = TB)
TB_con_mod_sum <- summary(TB_con_mod) # continuous
#TB %>% summary() # 25/148

## drinking_water
drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
drinking_water_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = drinking_water)
drinking_water_con_mod_sum <- summary(drinking_water_con_mod) # continuous
#drinking_water %>% summary() #129/145

## water_source
water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
water_source_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = water_source)
water_source_con_mod_sum <- summary(water_source_con_mod) # continuous
#water_source%>% summary()  #129/141

## overall_san
overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
overall_san_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = overall_san)
overall_san_con_mod_sum <- summary(overall_san_con_mod) # continuous
#overall_san %>% summary() #130/138
### other level3 
#DTP3
DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
DTP3_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) # continuous
#DTP3 %>% summary() #111/147
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
HepB3_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) # continuous
#HepB3 %>% summary() #103/128

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Hib3_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) # continuous
#Hib3 %>% summary() #75/89

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
# PCV3_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) # continuous
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Pol3_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) # continuous
#Pol3 %>% summary() #106/147

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Measles_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) # continuous
# Measles %>% summary() #108/147

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
RCV1_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = RCV1)
RCV1_con_mod_sum <- summary(RCV1_con_mod) # continuous
#RCV1 %>% summary() #73/105

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Nursing_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) # continuous
Nursing %>% summary() #61/91
# Physicians

Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Physicians_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) # continuous
#Physicians %>% summary() #76/96

#####there are more but not included here###########################
  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = useTot) # continuous
  useTot_con_mod_sum <-summary(useTot_con_mod)
  #useTot %>% summary() #55/56

  # level 2
## total per capita use --> TotalDDDPer1000Persons 50/65
totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
totDDD_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = totDDD)
totDDD_con_mod_sum <- summary(totDDD_con_mod) # continuous
#TotalDDDPer1000Persons %>%  summary() #50/65 country has an increase

## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
Broad <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
Broad_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = Broad)
Broad_con_mod_sum <- summary(Broad_con_mod) # continuous
#BroadPerTotalABXUse %>% summary() #47/65 country has an increase

## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
NewABXUse_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = NewABXUse)
NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod) # continuous
#NewABXUse %>% summary() #55/63 country has an increase

##### RESISTANCE-------------------------------

## ABR total
resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(all_of(common_columns)) %>% unique() %>% na.omit()
resTot_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = resTot)
resTot_con_mod_sum <- summary(resTot_con_mod) # continuous
#dpsir_final_res %>% summary() #16/32 country has an increase

##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","change","x0008","income","sign")) %>% unique() %>% na.omit() 
MRSA_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = MRSA)
MRSA_con_mod_sum <- summary(MRSA_con_mod) # continuous

##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","change","x0008","income","sign")) %>% unique() %>% na.omit()
CR_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = CR)
CR_con_mod_sum <- summary(CR_con_mod) # continuous
#summary(dpsir_final_CR) #20/28

##STR
STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","change","x0008","income","sign")) %>% unique() %>% na.omit()
STR_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = STR)
STR_con_mod_sum <- summary(STR_con_mod) # continuous
#summary(dpsir_final_STR) 13/25

##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","RESPONSE","change","x0008","income","sign")) %>% unique() %>% na.omit()
DRI_con_mod <- lmer(x0008 ~ RESPONSE + (1|income),  data = DRI)
DRI_con_mod_sum <- summary(DRI_con_mod) # continuous
# summary(dpsir_final_DRI) 21/25

#save model outputs as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san,
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
  }

fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(x0008 ~ RESPONSE + (1 | income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)

#grep the rows that shows the estimate for RESPONSE
combined_df <- combined_df %>%
  filter(term== "RESPONSE")

combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>%
  select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient","t-value","std.error","df","p.value")


# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, from = names(var_name_changes), to = var_name_changes)

combined_df$levels<- as.factor(combined_df$levels)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)

# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>%
    mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% 
    distinct() %>% 
    filter(sign == "+") %>%
    ungroup() %>% 
    select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>% 
  cols_label(DPSIR = "DPSE",         
             increasing= "Number of Countries with Increase",         
             sample_size = "Sample Size")

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Baseline and Mean Action Score (Response)**")) %>% 
 #   subtitle = md("T-test Statistics")
  #) %>%
  tab_footnote(
    footnote = md("lmer(Baseline ~ Action + (1|income))")
  )
# Print the gt table
gt_tbl

```

\pagebreak

# S15 Table. Linear Trend and Awareness and Education

```{r}
# lmer(change ~ AwarenessandEducation + x0008 + (1|income), data)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = driverTot) # continuous
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = infTot) # continuous
  infTot_con_mod_sum <-summary(infTot_con_mod)

  ## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = sanTot) # continuous
  sanTot_con_mod_sum <-summary(sanTot_con_mod)

  ## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = vacTot) # continuous
  vacTot_con_mod_sum <-summary(vacTot_con_mod)

  ## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = workTot) # continuous
  workTot_con_mod_sum <-summary(workTot_con_mod)

## HIV
HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HIV_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = HIV)
HIV_con_mod_sum <- summary(HIV_con_mod) # continuous

## TB
TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
TB_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = TB)
TB_con_mod_sum <- summary(TB_con_mod) # continuous

## drinking_water
drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
drinking_water_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = drinking_water)
drinking_water_con_mod_sum <- summary(drinking_water_con_mod) # continuous

## water_source
water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
water_source_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = water_source)
water_source_con_mod_sum <- summary(water_source_con_mod) # continuous

## overall_san
overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
overall_san_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = overall_san)
overall_san_con_mod_sum <- summary(overall_san_con_mod) # continuous

#DTP3
DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
DTP3_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) # continuous
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HepB3_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) # continuous

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Hib3_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) # continuous

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
# PCV3_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) # continuous
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Pol3_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) # continuous

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Measles_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) # continuous

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
RCV1_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = RCV1)

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Nursing_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) # continuous

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Physicians_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) # continuous

#####there are more but not included here###########################
  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = useTot) # continuous
  useTot_con_mod_sum <-summary(useTot_con_mod)

  # level 2
## total per capita use --> TotalDDDPer1000Persons 50/65
totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
totDDD_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = totDDD)
totDDD_con_mod_sum <- summary(totDDD_con_mod) # continuous

## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
Broad <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Broad_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = Broad)
Broad_con_mod_sum <- summary(Broad_con_mod) # continuous

## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
NewABXUse_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = NewABXUse)
NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod) # continuous

##### RESISTANCE-------------------------------

## ABR total
resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","change","x0008", "income","sign")) %>% unique() %>% na.omit()
resTot_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = resTot)
resTot_con_mod_sum <- summary(resTot_con_mod) # continuous

##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","change","x0008","income","sign")) %>% unique() %>% na.omit() 
MRSA_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = MRSA)
MRSA_con_mod_sum <- summary(MRSA_con_mod) # continuous

##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","change","x0008","income","sign")) %>% unique() %>% na.omit()
CR_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = CR)
CR_con_mod_sum <- summary(CR_con_mod) # continuous

##STR
STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","change","x0008","income","sign")) %>% unique() %>% na.omit()
STR_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = STR)
STR_con_mod_sum <- summary(STR_con_mod) # continuous

##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","change","x0008","income","sign")) %>% unique() %>% na.omit()
DRI_con_mod <- lmer(change ~ AwarenessandEducation + x0008 + (1|income), data = DRI)
DRI_con_mod_sum <- summary(DRI_con_mod) # continuous

####save model outputs as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san,
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
 }

fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(change ~ AwarenessandEducation + x0008 + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)
#grep the rows that shows the estimate for AwarenessandEducation
combined_df <- combined_df %>%
  filter(term== "AwarenessandEducation")

combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")
# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, from = names(var_name_changes), to = var_name_changes)

combined_df$levels<- as.factor(combined_df$levels)
combined_df$variable <- as.character(combined_df$variable)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)

# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>%   
  cols_label(DPSIR = "DPSE",              increasing= "Number of Countries with Increase",              sample_size = "Sample Size")
              

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and Awareness and Education Action Score**")) %>% 
  # #  subtitle = md("T-test Statistics")
  # ) %>%
  tab_footnote(
    footnote = md("lmer(Linear Trend ~ Awareness and Education + Baseline + (1|income))")
  )
# Print the gt table
gt_tbl
```

\pagebreak
# S16 Table. Categorical Trend and Awareness and Education

```{r}
#   useTot_con_mod<- lmer(AwarenessandEducation ~ sign + x0008, data = useTot)
dpsir_final$sign <- as.factor(dpsir_final$sign)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = driverTot) 
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  #driverTot %>% summary() 
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = infTot) 
  infTot_con_mod_sum <-summary(infTot_con_mod)
 # infTot%>% summary() #25/148 countries has increase
## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = sanTot) 
  sanTot_con_mod_sum <-summary(sanTot_con_mod)
#  sanTot %>%summary() #33/147 countries has increase
## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = vacTot) 
  vacTot_con_mod_sum <-summary(vacTot_con_mod)
#  vacTot %>% summary() #26/148 countries has increase
## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = workTot) 
  workTot_con_mod_sum <-summary(workTot_con_mod)
# workTot %>% summary() #32/106 countries has increase
  ## HIV
  HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  HIV_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = HIV)
  HIV_con_mod_sum <- summary(HIV_con_mod) 
  #summary(HIV) #25 positive among 148
  
  ## TB
  TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  TB_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = TB)
  TB_con_mod_sum <- summary(TB_con_mod) 
  #TB %>% summary() # 25/148
  
  ## drinking_water
  drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  drinking_water_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = drinking_water)
  drinking_water_con_mod_sum <- summary(drinking_water_con_mod) 
  #drinking_water %>% summary() #129/145
  
  ## water_source
  water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  water_source_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = water_source)
  water_source_con_mod_sum <- summary(water_source_con_mod)
  #water_source%>% summary()  #129/141
  
  ## overall_san
  overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  overall_san_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = overall_san)
  overall_san_con_mod_sum <- summary(overall_san_con_mod)  
  #overall_san %>% summary() #130/138
  
### other level3 
#DTP3
 DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
DTP3_con_mod <-  lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) 
# DTP3 %>% summary() #110/147
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HepB3_con_mod <-  lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) 
# HepB3 %>% summary() #102/128

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Hib3_con_mod <-  lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) 
# Hib3 %>% summary() #74/89

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
# PCV3_con_mod <-  lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) 
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Pol3_con_mod <-  lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) 
# Pol3 %>% summary() #106/147

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Measles_con_mod <-  lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) 
# Measles %>% summary() #108/147

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
RCV1_con_mod <-  lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = RCV1)
RCV1_con_mod_sum <- summary(RCV1_con_mod) 
#RCV1 %>% summary() #73/105

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Nursing_con_mod <-  lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) 
Nursing %>% summary() #61/91

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Physicians_con_mod <-  lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) 
# Physicians %>% summary() #76/96

  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = useTot)  
  useTot_con_mod_sum <-summary(useTot_con_mod)
  #useTot %>% summary() #55/56
  
  # level 2
  ## total per capita use --> TotalDDDPer1000Persons 50/65
  totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  totDDD_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = totDDD)
  totDDD_con_mod_sum <- summary(totDDD_con_mod)  
  #TotalDDDPer1000Persons %>%  summary() #50/65 country has an increase
  
  ## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
  Broad<- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  Broad_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = Broad)
  Broad_con_mod_sum <- summary(Broad_con_mod)  
  #BroadPerTotalABXUse %>% summary() #47/65 country has an increase
  
  ## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
  NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  NewABXUse_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = NewABXUse)
  NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod)  
  #NewABXUse %>% summary() #55/63 country has an increase
  
  ##### RESISTANCE-------------------------------
  
  ## ABR total
 resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","change","income","sign")) %>% unique() %>% na.omit()
  resTot_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = resTot)
  resTot_con_mod_sum <- summary(resTot_con_mod)  
  #dpsir_final_res %>% summary() #16/32 country has an increase
  
  ##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
  MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","change","income","sign")) %>% unique() %>% na.omit() 
    #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  MRSA_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = MRSA) 
  MRSA_con_mod_sum <- summary(MRSA_con_mod)  
  #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  
  ##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
  CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","change","income","sign")) %>% unique() %>% na.omit()
  CR_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = CR)
  CR_con_mod_sum <- summary(CR_con_mod)  
  #summary(dpsir_final_CR) #20/28
  
  ##STR
  STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","change","income","sign")) %>% unique() %>% na.omit()
  STR_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = STR)
  STR_con_mod_sum <- summary(STR_con_mod)  
  #summary(dpsir_final_STR) 13/25
  
  ##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","AwarenessandEducation","x0008","change","income","sign")) %>% unique() %>% na.omit()
  DRI_con_mod <- lmer(AwarenessandEducation ~ sign + x0008 + (1|income), data = DRI)
  DRI_con_mod_sum <- summary(DRI_con_mod)  
  # summary(dpsir_final_DRI) 21/25

  #save models as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san , 
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
}

fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(AwarenessandEducation ~ sign + x0008  + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)

#grep the rows that shows the estimate for sign+     ########CHECK HERE########
combined_df <- combined_df %>%
  filter(term== "sign+")
combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")

# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, from = names(var_name_changes), to = var_name_changes)

combined_df$levels<- as.factor(combined_df$levels)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)
# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>%    
  cols_label(DPSIR = "DPSE",              
             increasing= "Number of Countries with Increase",             
             sample_size = "Sample Size")

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and Mean Action Score**")) %>% 
  # #  subtitle = md("T-test Statistics with the action category: RESPONSE")
#   %>%
  tab_footnote(
    footnote = md("lmer(Awareness and Education ~ Categorical Trend + Baseline + (1|income))")
  #tab_source_note(source_note = md("Estimates are back transformed") # NO NEED ANYMORE BECAUSE THIS ISNT A BINOMIAL MODEL
  )
gt_tbl
```


\pagebreak
# S17 Table. Linear Trend and General

```{r}
# lmer(change ~ General + x0008 + (1|income), data)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(change ~ General + x0008 + (1|income), data = driverTot) # continuous
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(change ~ General + x0008 + (1|income), data = infTot) # continuous
  infTot_con_mod_sum <-summary(infTot_con_mod)

  ## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(change ~ General + x0008 + (1|income), data = sanTot) # continuous
  sanTot_con_mod_sum <-summary(sanTot_con_mod)

  ## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(change ~ General + x0008 + (1|income), data = vacTot) # continuous
  vacTot_con_mod_sum <-summary(vacTot_con_mod)

  ## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(change ~ General + x0008 + (1|income), data = workTot) # continuous
  workTot_con_mod_sum <-summary(workTot_con_mod)

## HIV
HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HIV_con_mod <- lmer(change ~ General + x0008 + (1|income), data = HIV)
HIV_con_mod_sum <- summary(HIV_con_mod) # continuous

## TB
TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
TB_con_mod <- lmer(change ~ General + x0008 + (1|income), data = TB)
TB_con_mod_sum <- summary(TB_con_mod) # continuous

## drinking_water
drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
drinking_water_con_mod <- lmer(change ~ General + x0008 + (1|income), data = drinking_water)
drinking_water_con_mod_sum <- summary(drinking_water_con_mod) # continuous

## water_source
water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
water_source_con_mod <- lmer(change ~ General + x0008 + (1|income), data = water_source)
water_source_con_mod_sum <- summary(water_source_con_mod) # continuous

## overall_san
overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
overall_san_con_mod <- lmer(change ~ General + x0008 + (1|income), data = overall_san)
overall_san_con_mod_sum <- summary(overall_san_con_mod) # continuous

#DTP3
DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
DTP3_con_mod <- lmer(change ~ General + x0008 + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) # continuous
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HepB3_con_mod <- lmer(change ~ General + x0008 + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) # continuous

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Hib3_con_mod <- lmer(change ~ General + x0008 + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) # continuous

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
# PCV3_con_mod <- lmer(change ~ General + x0008 + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) # continuous
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Pol3_con_mod <- lmer(change ~ General + x0008 + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) # continuous

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Measles_con_mod <- lmer(change ~ General + x0008 + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) # continuous

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
RCV1_con_mod <- lmer(change ~ General + x0008 + (1|income), data = RCV1)

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Nursing_con_mod <- lmer(change ~ General + x0008 + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) # continuous

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Physicians_con_mod <- lmer(change ~ General + x0008 + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) # continuous

#####there are more but not included here###########################
  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(change ~ General + x0008 + (1|income), data = useTot) # continuous
  useTot_con_mod_sum <-summary(useTot_con_mod)

  # level 2
## total per capita use --> TotalDDDPer1000Persons 50/65
totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
totDDD_con_mod <- lmer(change ~ General + x0008 + (1|income), data = totDDD)
totDDD_con_mod_sum <- summary(totDDD_con_mod) # continuous

## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
Broad <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Broad_con_mod <- lmer(change ~ General + x0008 + (1|income), data = Broad)
Broad_con_mod_sum <- summary(Broad_con_mod) # continuous

## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
NewABXUse_con_mod <- lmer(change ~ General + x0008 + (1|income), data = NewABXUse)
NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod) # continuous

##### RESISTANCE-------------------------------

## ABR total
resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","change","x0008", "income","sign")) %>% unique() %>% na.omit()
resTot_con_mod <- lmer(change ~ General + x0008 + (1|income), data = resTot)
resTot_con_mod_sum <- summary(resTot_con_mod) # continuous

##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","change","x0008","income","sign")) %>% unique() %>% na.omit() 
MRSA_con_mod <- lmer(change ~ General + x0008 + (1|income), data = MRSA)
MRSA_con_mod_sum <- summary(MRSA_con_mod) # continuous

##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","change","x0008","income","sign")) %>% unique() %>% na.omit()
CR_con_mod <- lmer(change ~ General + x0008 + (1|income), data = CR)
CR_con_mod_sum <- summary(CR_con_mod) # continuous

##STR
STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","change","x0008","income","sign")) %>% unique() %>% na.omit()
STR_con_mod <- lmer(change ~ General + x0008 + (1|income), data = STR)
STR_con_mod_sum <- summary(STR_con_mod) # continuous

##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","change","x0008","income","sign")) %>% unique() %>% na.omit()
DRI_con_mod <- lmer(change ~ General + x0008 + (1|income), data = DRI)
DRI_con_mod_sum <- summary(DRI_con_mod) # continuous

####save model outputs as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san,
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
 }

fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(change ~ General + x0008 + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)
#grep the rows that shows the estimate for General
combined_df <- combined_df %>%
  filter(term== "General")

combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")

# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, from = names(var_name_changes), to = var_name_changes)

combined_df$levels<- as.factor(combined_df$levels)
combined_df$variable <- as.character(combined_df$variable)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)
# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
 combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
  combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs 

}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>%   
  cols_label(DPSIR = "DPSE",  
             increasing= "Number of Countries with Increase",    
             sample_size = "Sample Size")
              

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and General Action Score**")) %>% 
  # #   subtitle = md("T-test Statistics")
  # ) %>%
  tab_footnote(
    footnote = md("lmer(Linear Trend ~ General + Baseline + (1|income))")
  ) 
# Print the gt table
gt_tbl
```

\pagebreak
# S18 Table. Categorical Trend and General

```{r}
#   useTot_con_mod<- lmer(General ~ sign + x0008  + (1|income), data = useTot)
dpsir_final$sign <- as.factor(dpsir_final$sign)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = driverTot) 
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  #driverTot %>% summary() 
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = infTot) 
  infTot_con_mod_sum <-summary(infTot_con_mod)
 # infTot%>% summary() #25/148 countries has increase
## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(General ~ sign + x0008  + (1|income), data = sanTot) 
  sanTot_con_mod_sum <-summary(sanTot_con_mod)
#  sanTot %>%summary() #33/147 countries has increase
## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = vacTot) 
  vacTot_con_mod_sum <-summary(vacTot_con_mod)
#  vacTot %>% summary() #26/148 countries has increase
## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = workTot) 
  workTot_con_mod_sum <-summary(workTot_con_mod)
# workTot %>% summary() #32/106 countries has increase
  ## HIV
  HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  HIV_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = HIV)
  HIV_con_mod_sum <- summary(HIV_con_mod) 
  #summary(HIV) #25 positive among 148
  
  ## TB
  TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  TB_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = TB)
  TB_con_mod_sum <- summary(TB_con_mod) 
  #TB %>% summary() # 25/148
  
  ## drinking_water
  drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  drinking_water_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = drinking_water)
  drinking_water_con_mod_sum <- summary(drinking_water_con_mod) 
  #drinking_water %>% summary() #129/145
  
  ## water_source
  water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  water_source_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = water_source)
  water_source_con_mod_sum <- summary(water_source_con_mod)
  #water_source%>% summary()  #129/141
  
  ## overall_san
  overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  overall_san_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = overall_san)
  overall_san_con_mod_sum <- summary(overall_san_con_mod)  
  #overall_san %>% summary() #130/138
  
### other level3 
#DTP3
 DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
DTP3_con_mod <-  lmer(General ~ sign + x0008  + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) 
# DTP3 %>% summary() #110/147
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HepB3_con_mod <-  lmer(General ~ sign + x0008  + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) 
# HepB3 %>% summary() #102/128

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Hib3_con_mod <-  lmer(General ~ sign + x0008  + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) 
# Hib3 %>% summary() #74/89

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
# PCV3_con_mod <-  lmer(General ~ sign + x0008  + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) 
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Pol3_con_mod <-  lmer(General ~ sign + x0008  + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) 
# Pol3 %>% summary() #106/147

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Measles_con_mod <-  lmer(General ~ sign + x0008  + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) 
# Measles %>% summary() #108/147

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
RCV1_con_mod <-  lmer(General ~ sign + x0008  + (1|income), data = RCV1)
RCV1_con_mod_sum <- summary(RCV1_con_mod) 
#RCV1 %>% summary() #73/105

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Nursing_con_mod <-  lmer(General ~ sign + x0008  + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) 
Nursing %>% summary() #61/91

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Physicians_con_mod <-  lmer(General ~ sign + x0008  + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) 
# Physicians %>% summary() #76/96

  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = useTot)  
  useTot_con_mod_sum <-summary(useTot_con_mod)
  #useTot %>% summary() #55/56
  
  # level 2
  ## total per capita use --> TotalDDDPer1000Persons 50/65
  totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  totDDD_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = totDDD)
  totDDD_con_mod_sum <- summary(totDDD_con_mod)  
  #TotalDDDPer1000Persons %>%  summary() #50/65 country has an increase
  
  ## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
  Broad<- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  Broad_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = Broad)
  Broad_con_mod_sum <- summary(Broad_con_mod)  
  #BroadPerTotalABXUse %>% summary() #47/65 country has an increase
  
  ## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
  NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  NewABXUse_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = NewABXUse)
  NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod)  
  #NewABXUse %>% summary() #55/63 country has an increase
  
  ##### RESISTANCE-------------------------------
  
  ## ABR total
 resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","change","income","sign")) %>% unique() %>% na.omit()
  resTot_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = resTot)
  resTot_con_mod_sum <- summary(resTot_con_mod)  
  #dpsir_final_res %>% summary() #16/32 country has an increase
  
  ##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
  MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","change","income","sign")) %>% unique() %>% na.omit() 
    #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  MRSA_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = MRSA) 
  MRSA_con_mod_sum <- summary(MRSA_con_mod)  
  #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  
  ##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
  CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","change","income","sign")) %>% unique() %>% na.omit()
  CR_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = CR)
  CR_con_mod_sum <- summary(CR_con_mod)  
  #summary(dpsir_final_CR) #20/28
  
  ##STR
  STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","change","income","sign")) %>% unique() %>% na.omit()
  STR_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = STR)
  STR_con_mod_sum <- summary(STR_con_mod)  
  #summary(dpsir_final_STR) 13/25
  
  ##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","General","x0008","change","income","sign")) %>% unique() %>% na.omit()
  DRI_con_mod <- lmer(General ~ sign + x0008  + (1|income), data = DRI)
  DRI_con_mod_sum <- summary(DRI_con_mod)  
  # summary(dpsir_final_DRI) 21/25

  #save models as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san , 
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
}
fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(General ~ sign + x0008  + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)

#grep the rows that shows the estimate for sign+     ########CHECK HERE########
combined_df <- combined_df %>%
  filter(term== "sign+")
combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")

# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, from = names(var_name_changes), to = var_name_changes)

combined_df$levels<- as.factor(combined_df$levels)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)
# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>%    
  cols_label(DPSIR = "DPSE",              
             increasing= "Number of Countries with Increase",             
             sample_size = "Sample Size")

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and Mean Action Score**")) %>% 
  # #  subtitle = md("T-test Statistics with the action category: RESPONSE")
#   %>%
  tab_footnote(
    footnote = md("lmer(General ~ Categorical Trend + Baseline + (1|income))")
  #tab_source_note(source_note = md("Estimates are back transformed") # NO NEED ANYMORE BECAUSE THIS ISNT A BINOMIAL MODEL
  )
gt_tbl

```

\pagebreak
# S19 Table. Linear Trend and Monitoring and Surveillance

```{r}
# lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = driverTot) # continuous
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = infTot) # continuous
  infTot_con_mod_sum <-summary(infTot_con_mod)

  ## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = sanTot) # continuous
  sanTot_con_mod_sum <-summary(sanTot_con_mod)

  ## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = vacTot) # continuous
  vacTot_con_mod_sum <-summary(vacTot_con_mod)

  ## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = workTot) # continuous
  workTot_con_mod_sum <-summary(workTot_con_mod)

## HIV
HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HIV_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = HIV)
HIV_con_mod_sum <- summary(HIV_con_mod) # continuous

## TB
TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
TB_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = TB)
TB_con_mod_sum <- summary(TB_con_mod) # continuous

## drinking_water
drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
drinking_water_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = drinking_water)
drinking_water_con_mod_sum <- summary(drinking_water_con_mod) # continuous

## water_source
water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
water_source_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = water_source)
water_source_con_mod_sum <- summary(water_source_con_mod) # continuous

## overall_san
overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
overall_san_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = overall_san)
overall_san_con_mod_sum <- summary(overall_san_con_mod) # continuous

#DTP3
DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
DTP3_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) # continuous
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HepB3_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) # continuous

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Hib3_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) # continuous

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
# PCV3_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) # continuous
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Pol3_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) # continuous

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Measles_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) # continuous

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
RCV1_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = RCV1)

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Nursing_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) # continuous

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Physicians_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) # continuous

#####there are more but not included here###########################
  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = useTot) # continuous
  useTot_con_mod_sum <-summary(useTot_con_mod)

  # level 2
## total per capita use --> TotalDDDPer1000Persons 50/65
totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
totDDD_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = totDDD)
totDDD_con_mod_sum <- summary(totDDD_con_mod) # continuous

## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
Broad <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Broad_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = Broad)
Broad_con_mod_sum <- summary(Broad_con_mod) # continuous

## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
NewABXUse_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = NewABXUse)
NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod) # continuous

##### RESISTANCE-------------------------------

## ABR total
resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","change","x0008", "income","sign")) %>% unique() %>% na.omit()
resTot_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = resTot)
resTot_con_mod_sum <- summary(resTot_con_mod) # continuous

##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","change","x0008","income","sign")) %>% unique() %>% na.omit() 
MRSA_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = MRSA)
MRSA_con_mod_sum <- summary(MRSA_con_mod) # continuous

##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","change","x0008","income","sign")) %>% unique() %>% na.omit()
CR_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = CR)
CR_con_mod_sum <- summary(CR_con_mod) # continuous

##STR
STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","change","x0008","income","sign")) %>% unique() %>% na.omit()
STR_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = STR)
STR_con_mod_sum <- summary(STR_con_mod) # continuous

##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","change","x0008","income","sign")) %>% unique() %>% na.omit()
DRI_con_mod <- lmer(change ~ MonitoringandSurveillance + x0008 + (1|income), data = DRI)
DRI_con_mod_sum <- summary(DRI_con_mod) # continuous

####save model outputs as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san,
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
 }

fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(change ~ MonitoringandSurveillance + x0008 + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)
#grep the rows that shows the estimate for MonitoringandSurveillance
combined_df <- combined_df %>%
  filter(term== "MonitoringandSurveillance")

combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")

# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, 
                                        from = names(var_name_changes), 
                                        to = var_name_changes)

combined_df$levels<- as.factor(combined_df$levels)
combined_df$variable <- as.character(combined_df$variable)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)
# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
 combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
 combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs 
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>%  
  cols_label(DPSIR = "DPSE",  
             increasing= "Number of Countries with Increase",  
             sample_size = "Sample Size")
              

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and Monitoring and Surveillance Action Score**")) %>% 
  # #   subtitle = md("T-test Statistics")
  # ) %>%
  tab_footnote(
    footnote = md("lmer(Linear Trend ~ Monitoring and Surveillance + Baseline + (1|income))")
  )
# Print the gt table
gt_tbl
```

\pagebreak
# S20 Table. Categorical Trend and Monitoring and Surveillance

```{r}
#   useTot_con_mod<- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = useTot)
dpsir_final$sign <- as.factor(dpsir_final$sign)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = driverTot) 
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  #driverTot %>% summary() 
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = infTot) 
  infTot_con_mod_sum <-summary(infTot_con_mod)
## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = sanTot) 
  sanTot_con_mod_sum <-summary(sanTot_con_mod)
## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = vacTot) 
  vacTot_con_mod_sum <-summary(vacTot_con_mod)
## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = workTot) 
  workTot_con_mod_sum <-summary(workTot_con_mod)
  ## HIV
  HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  HIV_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = HIV)
  HIV_con_mod_sum <- summary(HIV_con_mod) 
  #summary(HIV) #25 positive among 148
  
  ## TB
  TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  TB_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = TB)
  TB_con_mod_sum <- summary(TB_con_mod) 
  #TB %>% summary() # 25/148
  
  ## drinking_water
  drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  drinking_water_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = drinking_water)
  drinking_water_con_mod_sum <- summary(drinking_water_con_mod) 
  #drinking_water %>% summary() #129/145
  
  ## water_source
  water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  water_source_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = water_source)
  water_source_con_mod_sum <- summary(water_source_con_mod)
  #water_source%>% summary()  #129/141
  
  ## overall_san
  overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  overall_san_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = overall_san)
  overall_san_con_mod_sum <- summary(overall_san_con_mod)  
  #overall_san %>% summary() #130/138
  
### other level3 
#DTP3
 DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
DTP3_con_mod <-  lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) 
# DTP3 %>% summary() #110/147
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HepB3_con_mod <-  lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) 
# HepB3 %>% summary() #102/128

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Hib3_con_mod <-  lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) 
# Hib3 %>% summary() #74/89

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
# PCV3_con_mod <-  lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) 
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Pol3_con_mod <-  lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) 
# Pol3 %>% summary() #106/147

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Measles_con_mod <-  lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) 
# Measles %>% summary() #108/147

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
RCV1_con_mod <-  lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = RCV1)
RCV1_con_mod_sum <- summary(RCV1_con_mod) 
#RCV1 %>% summary() #73/105

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Nursing_con_mod <-  lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) 
Nursing %>% summary() #61/91

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Physicians_con_mod <-  lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) 
# Physicians %>% summary() #76/96

  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = useTot)  
  useTot_con_mod_sum <-summary(useTot_con_mod)
  #useTot %>% summary() #55/56
  
  # level 2
  ## total per capita use --> TotalDDDPer1000Persons 50/65
  totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  totDDD_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = totDDD)
  totDDD_con_mod_sum <- summary(totDDD_con_mod)  
  #TotalDDDPer1000Persons %>%  summary() #50/65 country has an increase
  
  ## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
  Broad<- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  Broad_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = Broad)
  Broad_con_mod_sum <- summary(Broad_con_mod)  
  #BroadPerTotalABXUse %>% summary() #47/65 country has an increase
  
  ## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
  NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  NewABXUse_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = NewABXUse)
  NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod)  
  #NewABXUse %>% summary() #55/63 country has an increase
  
  ##### RESISTANCE-------------------------------
  
  ## ABR total
 resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","change","income","sign")) %>% unique() %>% na.omit()
  resTot_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = resTot)
  resTot_con_mod_sum <- summary(resTot_con_mod)  
  #dpsir_final_res %>% summary() #16/32 country has an increase
  
  ##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
  MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","change","income","sign")) %>% unique() %>% na.omit() 
    #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  MRSA_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = MRSA) 
  MRSA_con_mod_sum <- summary(MRSA_con_mod)  
  #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  
  ##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
  CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","change","income","sign")) %>% unique() %>% na.omit()
  CR_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = CR)
  CR_con_mod_sum <- summary(CR_con_mod)  
  #summary(dpsir_final_CR) #20/28
  
  ##STR
  STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","change","income","sign")) %>% unique() %>% na.omit()
  STR_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = STR)
  STR_con_mod_sum <- summary(STR_con_mod)  
  #summary(dpsir_final_STR) 13/25
  
  ##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","MonitoringandSurveillance","x0008","change","income","sign")) %>% unique() %>% na.omit()
  DRI_con_mod <- lmer(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = DRI)
  DRI_con_mod_sum <- summary(DRI_con_mod)  
  # summary(dpsir_final_DRI) 21/25

  #save models as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san , 
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
}
fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(MonitoringandSurveillance ~ sign + x0008 + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)

#grep the rows that shows the estimate for sign+     ########CHECK HERE########
combined_df <- combined_df %>%
  filter(term== "sign+")
combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")

# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, from = names(var_name_changes), to = var_name_changes)

combined_df$levels<- as.factor(combined_df$levels)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)
# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>%    
  cols_label(DPSIR = "DPSE",              
             increasing= "Number of Countries with Increase",             
             sample_size = "Sample Size")

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and Mean Action Score**")) %>% 
  # #  subtitle = md("T-test Statistics with the action category: RESPONSE")
#   %>%
  tab_footnote(
    footnote = md("lmer(Monitoring and Surveillance ~ Categorical Trend + Baseline + (1|income))")
  #tab_source_note(source_note = md("Estimates are back transformed") # NO NEED ANYMORE BECAUSE THIS ISNT A BINOMIAL MODEL
  )
gt_tbl
```

\pagebreak
# S21 Table. Linear Trend and Prevention  

```{r}
# lmer(change ~ Prevention + x0008 + (1|income), data)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = driverTot) # continuous
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = infTot) # continuous
  infTot_con_mod_sum <-summary(infTot_con_mod)

  ## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(change ~ Prevention + x0008 + (1|income), data = sanTot) # continuous
  sanTot_con_mod_sum <-summary(sanTot_con_mod)

  ## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = vacTot) # continuous
  vacTot_con_mod_sum <-summary(vacTot_con_mod)

  ## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = workTot) # continuous
  workTot_con_mod_sum <-summary(workTot_con_mod)

## HIV
HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HIV_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = HIV)
HIV_con_mod_sum <- summary(HIV_con_mod) # continuous

## TB
TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
TB_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = TB)
TB_con_mod_sum <- summary(TB_con_mod) # continuous

## drinking_water
drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
drinking_water_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = drinking_water)
drinking_water_con_mod_sum <- summary(drinking_water_con_mod) # continuous

## water_source
water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
water_source_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = water_source)
water_source_con_mod_sum <- summary(water_source_con_mod) # continuous

## overall_san
overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
overall_san_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = overall_san)
overall_san_con_mod_sum <- summary(overall_san_con_mod) # continuous

#DTP3
DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
DTP3_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) # continuous
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HepB3_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) # continuous

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Hib3_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) # continuous

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
# PCV3_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) # continuous
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Pol3_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) # continuous

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Measles_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) # continuous

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
RCV1_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = RCV1)

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Nursing_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) # continuous

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Physicians_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) # continuous

#####there are more but not included here###########################
  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = useTot) # continuous
  useTot_con_mod_sum <-summary(useTot_con_mod)

  # level 2
## total per capita use --> TotalDDDPer1000Persons 50/65
totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
totDDD_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = totDDD)
totDDD_con_mod_sum <- summary(totDDD_con_mod) # continuous

## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
Broad <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Broad_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = Broad)
Broad_con_mod_sum <- summary(Broad_con_mod) # continuous

## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
NewABXUse_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = NewABXUse)
NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod) # continuous

##### RESISTANCE-------------------------------

## ABR total
resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","change","x0008", "income","sign")) %>% unique() %>% na.omit()
resTot_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = resTot)
resTot_con_mod_sum <- summary(resTot_con_mod) # continuous

##  with levels of MRSA declining
MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","change","x0008","income","sign")) %>% unique() %>% na.omit() 
MRSA_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = MRSA)
MRSA_con_mod_sum <- summary(MRSA_con_mod) # continuous


CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","change","x0008","income","sign")) %>% unique() %>% na.omit()
CR_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = CR)
CR_con_mod_sum <- summary(CR_con_mod) # continuous

##STR
STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","change","x0008","income","sign")) %>% unique() %>% na.omit()
STR_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = STR)
STR_con_mod_sum <- summary(STR_con_mod) # continuous

##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","change","x0008","income","sign")) %>% unique() %>% na.omit()
DRI_con_mod <- lmer(change ~ Prevention + x0008 + (1|income), data = DRI)
DRI_con_mod_sum <- summary(DRI_con_mod) # continuous

####save model outputs as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san,
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
 }

fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(change ~ Prevention + x0008 + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)
#grep the rows that shows the estimate for Prevention
combined_df <- combined_df %>%
  filter(term== "Prevention")

combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")

# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, 
                                        from = names(var_name_changes), 
                                        to = var_name_changes)
combined_df$levels<- as.factor(combined_df$levels)
combined_df$variable <- as.character(combined_df$variable)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)
# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
 combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
 combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs 
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>% 
  cols_label(DPSIR = "DPSE",              increasing= "Number of Countries with Increase",              sample_size = "Sample Size")
              

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and Prevention Action Score**")) %>% 
  # #   subtitle = md("T-test Statistics")
  # ) %>%
  tab_footnote(
    footnote = md("lmer(Linear Trend ~ Prevention + Baseline + (1|income))"))
  # )%>%
  #  tab_source_note(
  #   source_note = md("Baseline for Drivers involves 2000-2010 data,
  #   Baseline for Use, Resistance, DRI involves 2000-2008 data.")
  # )
# Print the gt table
gt_tbl
```

\pagebreak
# S22 Table. Categorical Trend and Prevention

```{r}
#   useTot_con_mod<- lmer(Prevention ~ sign + x0008 + (1|income), data = useTot)
dpsir_final$sign <- as.factor(dpsir_final$sign)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = driverTot) 
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  #driverTot %>% summary() 
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = infTot) 
  infTot_con_mod_sum <-summary(infTot_con_mod)
## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(Prevention ~ sign + x0008 + (1|income), data = sanTot) 
  sanTot_con_mod_sum <-summary(sanTot_con_mod)
#  sanTot %>%summary() #33/147 countries has increase
## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = vacTot) 
  vacTot_con_mod_sum <-summary(vacTot_con_mod)
#  vacTot %>% summary() #26/148 countries has increase
## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = workTot) 
  workTot_con_mod_sum <-summary(workTot_con_mod)
# workTot %>% summary() #32/106 countries has increase
  ## HIV
  HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  HIV_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = HIV)
  HIV_con_mod_sum <- summary(HIV_con_mod) 
  #summary(HIV) #25 positive among 148
  
  ## TB
  TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  TB_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = TB)
  TB_con_mod_sum <- summary(TB_con_mod) 
  #TB %>% summary() # 25/148
  
  ## drinking_water
  drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  drinking_water_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = drinking_water)
  drinking_water_con_mod_sum <- summary(drinking_water_con_mod) 
  #drinking_water %>% summary() #129/145
  
  ## water_source
  water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  water_source_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = water_source)
  water_source_con_mod_sum <- summary(water_source_con_mod)
  #water_source%>% summary()  #129/141
  
  ## overall_san
  overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  overall_san_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = overall_san)
  overall_san_con_mod_sum <- summary(overall_san_con_mod)  
  #overall_san %>% summary() #130/138
  
### other level3 
#DTP3
 DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
DTP3_con_mod <-  lmer(Prevention ~ sign + x0008 + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) 
# DTP3 %>% summary() #110/147
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HepB3_con_mod <-  lmer(Prevention ~ sign + x0008 + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) 
# HepB3 %>% summary() #102/128

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Hib3_con_mod <-  lmer(Prevention ~ sign + x0008 + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) 
# Hib3 %>% summary() #74/89

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
# PCV3_con_mod <-  lmer(Prevention ~ sign + x0008 + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) 
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Pol3_con_mod <-  lmer(Prevention ~ sign + x0008 + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) 
# Pol3 %>% summary() #106/147

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Measles_con_mod <-  lmer(Prevention ~ sign + x0008 + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) 
# Measles %>% summary() #108/147

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
RCV1_con_mod <-  lmer(Prevention ~ sign + x0008 + (1|income), data = RCV1)
RCV1_con_mod_sum <- summary(RCV1_con_mod) 
#RCV1 %>% summary() #73/105

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Nursing_con_mod <-  lmer(Prevention ~ sign + x0008 + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) 
Nursing %>% summary() #61/91

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Physicians_con_mod <-  lmer(Prevention ~ sign + x0008 + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) 
# Physicians %>% summary() #76/96

  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = useTot)  
  useTot_con_mod_sum <-summary(useTot_con_mod)
  #useTot %>% summary() #55/56
  
  # level 2
  ## total per capita use --> TotalDDDPer1000Persons 50/65
  totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  totDDD_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = totDDD)
  totDDD_con_mod_sum <- summary(totDDD_con_mod)  
  #TotalDDDPer1000Persons %>%  summary() #50/65 country has an increase
  
  ## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
  Broad<- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  Broad_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = Broad)
  Broad_con_mod_sum <- summary(Broad_con_mod)  
  #BroadPerTotalABXUse %>% summary() #47/65 country has an increase
  
  ## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
  NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  NewABXUse_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = NewABXUse)
  NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod)  
  #NewABXUse %>% summary() #55/63 country has an increase
  
  ##### RESISTANCE-------------------------------
  
  ## ABR total
 resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","change","income","sign")) %>% unique() %>% na.omit()
  resTot_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = resTot)
  resTot_con_mod_sum <- summary(resTot_con_mod)  
  #dpsir_final_res %>% summary() #16/32 country has an increase
  
  ##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
  MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","change","income","sign")) %>% unique() %>% na.omit() 
    #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  MRSA_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = MRSA) 
  MRSA_con_mod_sum <- summary(MRSA_con_mod)  
  #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  
  ##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
  CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","change","income","sign")) %>% unique() %>% na.omit()
  CR_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = CR)
  CR_con_mod_sum <- summary(CR_con_mod)  
  #summary(dpsir_final_CR) #20/28
  
  ##STR
  STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","change","income","sign")) %>% unique() %>% na.omit()
  STR_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = STR)
  STR_con_mod_sum <- summary(STR_con_mod)  
  #summary(dpsir_final_STR) 13/25
  
  ##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","Prevention","x0008","change","income","sign")) %>% unique() %>% na.omit()
  DRI_con_mod <- lmer(Prevention ~ sign + x0008 + (1|income), data = DRI)
  DRI_con_mod_sum <- summary(DRI_con_mod)  
  # summary(dpsir_final_DRI) 21/25

  #save models as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san , 
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
}
fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(Prevention ~ sign + x0008 + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)

#grep the rows that shows the estimate for sign+     ########CHECK HERE########
combined_df <- combined_df %>%
  filter(term== "sign+")
combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")

# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, from = names(var_name_changes), to = var_name_changes)

combined_df$levels<- as.factor(combined_df$levels)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)
# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>%    
  cols_label(DPSIR = "DPSE",              
             increasing= "Number of Countries with Increase",             
             sample_size = "Sample Size")

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and Mean Action Score**")) %>% 
  # #  subtitle = md("T-test Statistics with the action category: RESPONSE")
#   %>%
  tab_footnote(
    footnote = md("lmer(Prevention ~ Categorical Trend + Baseline + (1|income))")
  #tab_source_note(source_note = md("Estimates are back transformed") # NO NEED ANYMORE BECAUSE THIS ISNT A BINOMIAL MODEL
  )
gt_tbl
```

\pagebreak
# S23 Table. Linear Trend and Regulation

```{r}
# lmer(change ~ Regulation + x0008 + (1|income), data)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = driverTot) # continuous
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = infTot) # continuous
  infTot_con_mod_sum <-summary(infTot_con_mod)

  ## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(change ~ Regulation + x0008 + (1|income), data = sanTot) # continuous
  sanTot_con_mod_sum <-summary(sanTot_con_mod)

  ## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = vacTot) # continuous
  vacTot_con_mod_sum <-summary(vacTot_con_mod)

  ## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = workTot) # continuous
  workTot_con_mod_sum <-summary(workTot_con_mod)

## HIV
HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HIV_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = HIV)
HIV_con_mod_sum <- summary(HIV_con_mod) # continuous

## TB
TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
TB_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = TB)
TB_con_mod_sum <- summary(TB_con_mod) # continuous

## drinking_water
drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
drinking_water_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = drinking_water)
drinking_water_con_mod_sum <- summary(drinking_water_con_mod) # continuous

## water_source
water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
water_source_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = water_source)
water_source_con_mod_sum <- summary(water_source_con_mod) # continuous

## overall_san
overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
overall_san_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = overall_san)
overall_san_con_mod_sum <- summary(overall_san_con_mod) # continuous

#DTP3
DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
DTP3_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) # continuous
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HepB3_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) # continuous

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Hib3_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) # continuous

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
# PCV3_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) # continuous
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Pol3_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) # continuous

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Measles_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) # continuous

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
RCV1_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = RCV1)

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Nursing_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) # continuous

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Physicians_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) # continuous

#####there are more but not included here###########################
  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = useTot) # continuous
  useTot_con_mod_sum <-summary(useTot_con_mod)

  # level 2
## total per capita use --> TotalDDDPer1000Persons 50/65
totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
totDDD_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = totDDD)
totDDD_con_mod_sum <- summary(totDDD_con_mod) # continuous

## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
Broad <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Broad_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = Broad)
Broad_con_mod_sum <- summary(Broad_con_mod) # continuous

## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
NewABXUse_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = NewABXUse)
NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod) # continuous

##### RESISTANCE-------------------------------

## ABR total
resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","change","x0008", "income","sign")) %>% unique() %>% na.omit()
resTot_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = resTot)
resTot_con_mod_sum <- summary(resTot_con_mod) # continuous

##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","change","x0008","income","sign")) %>% unique() %>% na.omit() 
MRSA_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = MRSA)
MRSA_con_mod_sum <- summary(MRSA_con_mod) # continuous

##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","change","x0008","income","sign")) %>% unique() %>% na.omit()
CR_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = CR)
CR_con_mod_sum <- summary(CR_con_mod) # continuous

##STR
STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","change","x0008","income","sign")) %>% unique() %>% na.omit()
STR_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = STR)
STR_con_mod_sum <- summary(STR_con_mod) # continuous

##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","change","x0008","income","sign")) %>% unique() %>% na.omit()
DRI_con_mod <- lmer(change ~ Regulation + x0008 + (1|income), data = DRI)
DRI_con_mod_sum <- summary(DRI_con_mod) # continuous

####save model outputs as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san,
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
 }

fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(change ~ Regulation + x0008 + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)
#grep the rows that shows the estimate for Regulation
combined_df <- combined_df %>%
  filter(term== "Regulation")

combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")

# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, 
                                        from = names(var_name_changes), 
                                        to = var_name_changes)
combined_df$levels<- as.factor(combined_df$levels)
combined_df$variable <- as.character(combined_df$variable)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)
# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
 combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
 combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs 
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>%
  cols_label(DPSIR = "DPSE",
             increasing= "Number of Countries with Increase", 
             sample_size = "Sample Size")
              

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and Regulation Action Score**")) %>% 
  #   subtitle = md("T-test Statistics")
  # ) %>%
  tab_footnote(
    footnote = md("lmer(Linear Trend ~ Regulation + Baseline + (1|income))")
  ) 
# Print the gt table
gt_tbl
```
\pagebreak
# S24 Table. Categorical Trend and Regulation

```{r}
#   useTot_con_mod<- lmer(Regulation ~ sign + x0008 + (1|income), data = useTot)
dpsir_final$sign <- as.factor(dpsir_final$sign)
fun_con <- function(dpsir_final_subset){
  #DRIVER-------------------------------------------------
  driverTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "driverTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  driverTot_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = driverTot) 
  driverTot_con_mod_sum <-summary(driverTot_con_mod)
  #driverTot %>% summary() 
  # level 2
## infTotal 
  infTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "infTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  infTot_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = infTot) 
  infTot_con_mod_sum <-summary(infTot_con_mod)
 # infTot%>% summary() #25/148 countries has increase
## sanTotal 
  sanTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "sanTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  sanTot_con_mod<- lmer(Regulation ~ sign + x0008 + (1|income), data = sanTot) 
  sanTot_con_mod_sum <-summary(sanTot_con_mod)
#  sanTot %>%summary() #33/147 countries has increase
## vacTotal 
  vacTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "vacTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  vacTot_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = vacTot) 
  vacTot_con_mod_sum <-summary(vacTot_con_mod)
#  vacTot %>% summary() #26/148 countries has increase
## workTotal 
  workTot <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME == "workTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  workTot_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = workTot) 
  workTot_con_mod_sum <-summary(workTot_con_mod)
# workTot %>% summary() #32/106 countries has increase
  ## HIV
  HIV <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="HIV") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  HIV_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = HIV)
  HIV_con_mod_sum <- summary(HIV_con_mod) 
  #summary(HIV) #25 positive among 148
  
  ## TB
  TB <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="TB") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  TB_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = TB)
  TB_con_mod_sum <- summary(TB_con_mod) 
  #TB %>% summary() # 25/148
  
  ## drinking_water
  drinking_water <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME=="Drinking Water Source") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  drinking_water_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = drinking_water)
  drinking_water_con_mod_sum <- summary(drinking_water_con_mod) 
  #drinking_water %>% summary() #129/145
  
  ## water_source
  water_source <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Water Source Access") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  water_source_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = water_source)
  water_source_con_mod_sum <- summary(water_source_con_mod)
  #water_source%>% summary()  #129/141
  
  ## overall_san
  overall_san <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Overall Sanitation") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  overall_san_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = overall_san)
  overall_san_con_mod_sum <- summary(overall_san_con_mod)  
  #overall_san %>% summary() #130/138
  
### other level3 
#DTP3
 DTP3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "DTP3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
DTP3_con_mod <-  lmer(Regulation ~ sign + x0008 + (1|income), data = DTP3)
DTP3_con_mod_sum <- summary(DTP3_con_mod) 
# DTP3 %>% summary() #110/147
# HepB3
HepB3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "HepB3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
HepB3_con_mod <-  lmer(Regulation ~ sign + x0008 + (1|income), data = HepB3)
HepB3_con_mod_sum <- summary(HepB3_con_mod) 
# HepB3 %>% summary() #102/128

# Hib3
Hib3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Hib3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Hib3_con_mod <-  lmer(Regulation ~ sign + x0008 + (1|income), data = Hib3)
Hib3_con_mod_sum <- summary(Hib3_con_mod) 
# Hib3 %>% summary() #74/89

# PCV3
## NOTE! change is empty thus excluded
# PCV3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "PCV3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
# PCV3_con_mod <-  lmer(Regulation ~ sign + x0008 + (1|income), data = PCV3)
# PCV3_con_mod_sum <- summary(PCV3_con_mod) 
# #PCV3 %>% summary() #111/147

# Pol3
Pol3 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Pol3") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Pol3_con_mod <-  lmer(Regulation ~ sign + x0008 + (1|income), data = Pol3)
Pol3_con_mod_sum <- summary(Pol3_con_mod) 
# Pol3 %>% summary() #106/147

# Measles
Measles <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Measles") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Measles_con_mod <-  lmer(Regulation ~ sign + x0008 + (1|income), data = Measles)
Measles_con_mod_sum <- summary(Measles_con_mod) 
# Measles %>% summary() #108/147

# RCV1
RCV1 <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "RCV1") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
RCV1_con_mod <-  lmer(Regulation ~ sign + x0008 + (1|income), data = RCV1)
RCV1_con_mod_sum <- summary(RCV1_con_mod) 
#RCV1 %>% summary() #73/105

# Nursing
Nursing <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Nursing & midwifery") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Nursing_con_mod <-  lmer(Regulation ~ sign + x0008 + (1|income), data = Nursing)
Nursing_con_mod_sum <- summary(Nursing_con_mod) 
Nursing %>% summary() #61/91

# Physicians
Physicians <- dpsir_final %>% filter(DPSIR=="DRIVERS" & SHORTNAME== "Physicians") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
Physicians_con_mod <-  lmer(Regulation ~ sign + x0008 + (1|income), data = Physicians)
Physicians_con_mod_sum <- summary(Physicians_con_mod) 
# Physicians %>% summary() #76/96

  #USE-------------------------------------------------
  useTot <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME == "useTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  useTot_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = useTot)  
  useTot_con_mod_sum <-summary(useTot_con_mod)
  #useTot %>% summary() #55/56
  
  # level 2
  ## total per capita use --> TotalDDDPer1000Persons 50/65
  totDDD <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="TotalDDDPer1000Persons") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  totDDD_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = totDDD)
  totDDD_con_mod_sum <- summary(totDDD_con_mod)  
  #TotalDDDPer1000Persons %>%  summary() #50/65 country has an increase
  
  ## use of broad spectrum antibiotics  --> BroadPerTotalABXUse
  Broad<- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="BroadPerTotalABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  Broad_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = Broad)
  Broad_con_mod_sum <- summary(Broad_con_mod)  
  #BroadPerTotalABXUse %>% summary() #47/65 country has an increase
  
  ## newly available antibiotics (mean=0.31 SD, P<0.001, 55/63, P<0.001, Fig S0c-d). --> NewABXUse
  NewABXUse <- dpsir_final %>% filter(DPSIR=="USE" & SHORTNAME=="NewABXUse") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","x0816","change","income","sign")) %>% unique() %>% na.omit()
  NewABXUse_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = NewABXUse)
  NewABXUse_con_mod_sum <- summary(NewABXUse_con_mod)  
  #NewABXUse %>% summary() #55/63 country has an increase
  
  ##### RESISTANCE-------------------------------
  
  ## ABR total
 resTot <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="resTotal") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","change","income","sign")) %>% unique() %>% na.omit()
  resTot_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = resTot)
  resTot_con_mod_sum <- summary(resTot_con_mod)  
  #dpsir_final_res %>% summary() #16/32 country has an increase
  
  ##  with levels of MRSA declining (mean = -0.16 SD, P=0.06, 21/32 countries, P=0.04)
  MRSA <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="MRSA") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","change","income","sign")) %>% unique() %>% na.omit() 
    #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  MRSA_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = MRSA) 
  MRSA_con_mod_sum <- summary(MRSA_con_mod)  
  #dpsir_final_MRSA %>% summary() #11/32 country has an increase
  
  ##while emerging types of resistance to last-resort carbapenems in Enterobacteriaceae 
  CR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="CR") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","change","income","sign")) %>% unique() %>% na.omit()
  CR_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = CR)
  CR_con_mod_sum <- summary(CR_con_mod)  
  #summary(dpsir_final_CR) #20/28
  
  ##STR
  STR <- dpsir_final %>% filter(DPSIR=="RESISTANCE" & SHORTNAME=="STR") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","change","income","sign")) %>% unique() %>% na.omit()
  STR_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = STR)
  STR_con_mod_sum <- summary(STR_con_mod)  
  #summary(dpsir_final_STR) 13/25
  
  ##DRI--------------------------
DRI <- dpsir_final %>% filter(DPSIR=="DRI") %>% select(c("ISO3", "SHORTNAME","DPSIR","Regulation","x0008","change","income","sign")) %>% unique() %>% na.omit()
  DRI_con_mod <- lmer(Regulation ~ sign + x0008 + (1|income), data = DRI)
  DRI_con_mod_sum <- summary(DRI_con_mod)  
  # summary(dpsir_final_DRI) 21/25

  #save models as a list
lmer_modlist <- list(driverTot_con_mod=driverTot_con_mod, infTot_con_mod = infTot_con_mod, sanTot_con_mod = sanTot_con_mod, vacTot_con_mod = vacTot_con_mod,  workTot_con_mod = workTot_con_mod, 
            HIV_con_mod=HIV_con_mod, TB_con_mod=TB_con_mod, drinking_water_con_mod=drinking_water_con_mod, water_source_con_mod=water_source_con_mod, overall_san_con_mod=overall_san_con_mod, 
            DTP3_con_mod = DTP3_con_mod, HepB3_con_mod = HepB3_con_mod, Hib3_con_mod = Hib3_con_mod, Pol3_con_mod = Pol3_con_mod, Measles_con_mod = Measles_con_mod, RCV1_con_mod = RCV1_con_mod, Nursing_con_mod = Nursing_con_mod, Physicians_con_mod = Physicians_con_mod,
            useTot_con_mod=useTot_con_mod, totDDD_con_mod=totDDD_con_mod, Broad_con_mod=Broad_con_mod, NewABXUse_con_mod=NewABXUse_con_mod, resTot_con_mod=resTot_con_mod, MRSA_con_mod=MRSA_con_mod, CR_con_mod=CR_con_mod, STR_con_mod=STR_con_mod,DRI_con_mod=DRI_con_mod)

#save mod summaries as a list
mod_data_list <- list(driverTot =driverTot, infTot  = infTot , sanTot  = sanTot , vacTot  = vacTot ,  workTot  = workTot ,  
            HIV =HIV , TB =TB , drinking_water =drinking_water , water_source =water_source , overall_san =overall_san , 
            DTP3  = DTP3 , HepB3  = HepB3 , Hib3  = Hib3 , Pol3  = Pol3 , Measles  = Measles , RCV1  = RCV1 , Nursing  = Nursing , Physicians  = Physicians ,
            useTot =useTot , totDDD =totDDD , Broad =Broad , NewABXUse =NewABXUse , resTot =resTot , MRSA =MRSA , CR =CR ,STR =STR ,DRI =DRI )
 lmer_result <- list(lmer_modlist = lmer_modlist, mod_data_list = mod_data_list)
return(lmer_result)
}
fun_con_result<- fun_con(dpsir_final)

lmer_mod_data <- fun_con_result$mod_data_list
lmer_mod_l <- fun_con_result$lmer_modlist

df_list <- lapply(fun_con_result$lmer_modlist, broom.mixed::tidy)
# add p values
results <- lapply(1:length(lmer_mod_l), function(i) {
  afex::mixed(Regulation ~ sign + x0008 + (1|income), data = lmer_mod_data[[i]])
})
# extract p values
p_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`Pr(>F)`
})

# extract den Df
den_Df_val <- lapply(1:length(results), function(i) {
results[[i]]$anova_table$`den Df`
})

# Combine the dataframes into a single dataframe
combined_df <- do.call(rbind, df_list)
combined_df$model_names <- row.names(combined_df)

#grep the rows that shows the estimate for sign+     ########CHECK HERE########
combined_df <- combined_df %>%
  filter(term== "sign+")
combined_df$variable <- strsplit(combined_df$model_names, "_con_mod.2")

# add p vals
for (i in 1:length(p_val)) {
combined_df$p.value[i] <- p_val[[i]]
}
# add den Df vals
for (i in 1:length(den_Df_val)) {
combined_df$df[i] <- den_Df_val[[i]]
}

combined_df <- combined_df %>% select(-c("term", "model_names")) %>%   
  mutate(levels = case_when(
           variable %in% c("driverTot", "useTot","resTot", "DRI") ~ "level 1",
           variable %in% c("totDDD" , "Broad" , "NewABXUse" , "MRSA", "STR", "CR",  "workTot" ,"sanTot", "vacTot","infTot" ) ~ "level 2",
           variable %in% c("HIV", "TB", "drinking_water", "water_source", "overall_san") ~ "level 3",
           variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1", "Nursing","Physicians") ~ "level 3")) %>%   
  mutate(DPSIR = case_when(
           variable %in% c("driverTot", "workTot" ,"sanTot", "vacTot","infTot") ~ "Drivers",
           variable %in% c("useTot", "totDDD" , "Broad" , "NewABXUse" ) ~ "Use",
           variable %in% c("resTot", "MRSA", "STR", "CR" ) ~ "Resistance",
           variable %in% c("DRI" ) ~ "DRI",
          ##level 3
          variable %in% c("HIV", "TB") ~ "Drivers/infections",
          variable %in% c( "drinking_water", "water_source", "overall_san") ~ "Drivers/Sanitation",
          variable %in% c("DTP3","HepB3","Hib3","Pol3","Measles","RCV1" ) ~ "Drivers/Vaccination",
          variable %in% c("Nursing","Physicians"  ) ~  "Drivers/Workforce")) %>% 
  rename("t-value" = "statistic", 
         "Coefficient" ="estimate") %>% 
  select("variable", "DPSIR","levels", "Coefficient", "t-value","std.error","df","p.value")

# Replace the variable names
combined_df$variable <- as.character(combined_df$variable)
combined_df$variable <- plyr::mapvalues(combined_df$variable, from = names(var_name_changes), to = var_name_changes)

combined_df$levels<- as.factor(combined_df$levels)
# fix the p values
# thanks to https://www.r-bloggers.com/2016/03/correctly-reporting-p-values-in-summary-tables-reported-with-xtable/
fixp <- function(x, dig=3){
  x <- as.data.frame(x)
  x[,ncol(x)] <- round(x[,ncol(x)], dig)
  for(i in 1:nrow(x)){
    if(x[i,ncol(x)] == 0)
      x[i,ncol(x)] <- paste0("< .", paste0(rep(0,dig-1), collapse=""), "1")
  }
  x
}
combined_df <- fixp(combined_df)
# Arrange the levels in a specific order
level_order <- c("level 1", "level 2", "level 3")
# round the digits acc to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4483789/
combined_df$Coefficient <- round(combined_df$Coefficient, 2)
combined_df$"t-value" <- round(combined_df$"t-value", 1)
combined_df$std.error <- round(combined_df$std.error, 2)
combined_df$df <- round(combined_df$df, 1)
# add number of observations 
#use lmer_mod_data list
for (i in 1:length(lmer_mod_data)) {
  # Extract npos and nobs
  lmer_mod_data[[i]]$new <-  lmer_mod_data[[i]] %>% mutate(obs = nrow(lmer_mod_data[[i]])) %>% 
    group_by(sign) %>% 
    reframe(n_pos = n(), obs = obs) %>% distinct() %>% 
  filter(sign == "+") %>% ungroup() %>%  select(-sign)
}

for (i in 1:length(lmer_mod_data)) {
combined_df$increasing[i] <- lmer_mod_data[[i]]$new$n_pos
combined_df$sample_size[i] <- lmer_mod_data[[i]]$new$obs
}

gt_tbl <- combined_df %>%
  mutate(p.value = str_replace(p.value, "<0.001", "\\( < 0.001 \\)")) %>% 
  arrange(factor(levels, levels = level_order)) %>%
  group_by(levels) %>%
  gt() %>%    
  cols_label(DPSIR = "DPSE",              
             increasing= "Number of Countries with Increase",             
             sample_size = "Sample Size")

gt_tbl <- gt_tbl %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "p.value", rows = p.value < 0.05)
  ) %>%
  # tab_header(
  #   title = md("**Association Between Degree of Change and Mean Action Score**")) %>% 
  # #  subtitle = md("T-test Statistics with the action category: RESPONSE")
#   %>%
  tab_footnote(
    footnote = md("lmer(Regulation ~ Categorical Trend + Baseline + (1|income))")
  #tab_source_note(source_note = md("Estimates are back transformed") # NO NEED ANYMORE BECAUSE THIS ISNT A BINOMIAL MODEL
  )
gt_tbl

```


